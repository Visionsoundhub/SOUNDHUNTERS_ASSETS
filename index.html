<!DOCTYPE html>
<html lang="el">
<head>
    <meta charset="UTF-8">
    <title>Recording Test Lab v3 (Debug)</title>
    <style>
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center; 
            height: 100vh; 
            margin: 0; 
            background-color: #f0f0f0; 
            color: #333;
        }
        #main-container {
            text-align: center;
            padding: 2rem;
            background-color: white;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        #testButton { 
            font-size: 1.5rem; 
            padding: 20px 40px; 
            cursor: pointer; 
            border-radius: 10px; 
            border: 2px solid #333; 
            transition: background-color 0.3s, color 0.3s; 
            margin-top: 1rem;
        }
        #testButton:disabled { 
            cursor: not-allowed; 
            opacity: 0.5; 
        }
        #status { 
            margin-top: 20px; 
            font-size: 1.2rem; 
            font-weight: bold; 
            color: #c0392b; /* Red color for errors */
            height: 60px; /* More space for error messages */
            max-width: 500px;
        }
        #audioPlayerContainer { 
            margin-top: 20px; 
            min-height: 40px;
        }
    </style>
</head>
<body>

    <div id="main-container">
        <h1>Εργαστήριο Ηχογράφησης v3 (Debug)</h1>
        <p>Αν βλέπετε αυτό το κείμενο, το HTML λειτουργεί.</p>
        
        <button id="testButton">Start Test</button>
        <div id="status">Κατάσταση: Idle</div>
        <div id="audioPlayerContainer"></div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const testButton = document.getElementById('testButton');
            const statusDiv = document.getElementById('status');
            const audioPlayerContainer = document.getElementById('audioPlayerContainer');

            let buttonState = 'idle'; 
            let mediaRecorder;
            let audioChunks = [];
            let stream = null;
            let recordedAudioURL = null;

            function setState(newState) {
                buttonState = newState;
                updateUI();
            }

            function updateUI() {
                if(buttonState !== 'error') {
                    statusDiv.textContent = `Κατάσταση: ${buttonState}`;
                }
                switch (buttonState) {
                    case 'idle':
                        testButton.textContent = 'Start Test';
                        testButton.disabled = false;
                        testButton.style.backgroundColor = '#fff';
                        break;
                    case 'awaiting_permission':
                        testButton.textContent = 'Αναμονή για Άδεια...';
                        testButton.disabled = true;
                        testButton.style.backgroundColor = '#f0e68c';
                        break;
                    case 'ready_to_record':
                        testButton.textContent = 'Start Recording';
                        testButton.disabled = false;
                        testButton.style.backgroundColor = '#90ee90';
                        break;
                    case 'recording':
                        testButton.textContent = 'Stop Recording';
                        testButton.disabled = false;
                        testButton.style.backgroundColor = '#ff4757';
                        break;
                    case 'processing':
                        testButton.textContent = 'Processing...';
                        testButton.disabled = true;
                        testButton.style.backgroundColor = '#ffa502';
                        break;
                    case 'ready_to_play':
                        testButton.textContent = 'Play Recording';
                        testButton.disabled = false;
                        testButton.style.backgroundColor = '#1e90ff';
                        break;
                    case 'error':
                         testButton.textContent = 'Reset Test';
                         testButton.disabled = false;
                         testButton.style.backgroundColor = '#fff';
                         break;
                }
            }
            
            async function requestMicPermission() {
                setState('awaiting_permission');
                try {
                    stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    setState('ready_to_record');
                } catch (err) {
                    console.error("Microphone access error:", err.name, err.message);
                    // THIS IS THE NEW PART: Display the specific error to the user.
                    statusDiv.innerHTML = `Σφάλμα: ${err.name}<br><small style="font-weight:normal;">${err.message}</small>`;
                    setState('error');
                }
            }
            
            function startRecording() {
                if (!stream) return;
                audioChunks = [];
                recordedAudioURL = null;
                audioPlayerContainer.innerHTML = '';
                mediaRecorder = new MediaRecorder(stream);
                mediaRecorder.start();
                
                mediaRecorder.onstop = () => {
                    setState('processing');
                    const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
                    recordedAudioURL = URL.createObjectURL(audioBlob);
                    
                    const audio = new Audio(recordedAudioURL);
                    audio.onloadeddata = () => {
                        setState('ready_to_play');
                    };
                    audio.onerror = () => {
                        statusDiv.textContent = "Σφάλμα: Δεν ήταν δυνατή η φόρτωση του ήχου.";
                        setState('error');
                    }
                };
                
                setState('recording');
            }

            function stopRecording() {
                if (mediaRecorder) mediaRecorder.stop();
            }
            
            function playRecording() {
                if(recordedAudioURL) {
                    const playerElement = document.createElement('audio');
                    playerElement.src = recordedAudioURL;
                    playerElement.controls = true;
                    audioPlayerContainer.innerHTML = '';
                    audioPlayerContainer.appendChild(playerElement);
                    playerElement.play();
                }
            }

            testButton.addEventListener('click', () => {
                switch (buttonState) {
                    case 'idle':
                    case 'error': // Allow resetting from an error state
                        requestMicPermission();
                        break;
                    case 'ready_to_record':
                        startRecording();
                        break;
                    case 'recording':
                        stopRecording();
                        break;
                    case 'ready_to_play':
                        playRecording();
                        break;
                }
            });
            
            updateUI();
        });
    </script>
</body>
</html>
